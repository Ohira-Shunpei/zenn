---
title: "CircleCiä¸Šã§goè¨€èªã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å·®åˆ†å®Ÿè¡Œã™ã‚‹æ–¹æ³•"
emoji: "ğŸ“™"
type: "tech"
topics: [go, test]
published: false
---

## èƒŒæ™¯

ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹åº¦ã«ã€CircleCi ã‚’ç”¨ã„ã¦ go è¨€èªã§æ›¸ã‹ã‚ŒãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ãŸã®ã§ã™ãŒã€
å…¨ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã®ã«ç´„ 20 åˆ†è¦ã—ã¦ã„ã¾ã—ãŸã€‚

## ã‚´ãƒ¼ãƒ«

å¤‰æ›´ç®‡æ‰€ã«ã®ã¿ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ã€‚

## ã‚„ã£ã¦ã¿ãŸçµæœ

å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã«ã‚‚ä¾å­˜ã—ã¾ã™ãŒã€1åº¦ã®PRã§ç”Ÿã˜ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ•°ãã‚‰ã„ã§ã‚ã‚Œã°ã€
ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«è¦ã™ã‚‹æ™‚é–“ã‚’ç´„ 20 åˆ† â†’ ç´„ 4 åˆ†ã«çŸ­ç¸®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## å·®åˆ†å®Ÿè¡Œã«ã™ã‚‹å‰ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

```Â yaml
- run:
  name: Run tests & make report
  command: |
    echo "" > coverage.txt
    for package_path in $(go list ./... ); do
        go test -v -race -coverprofile=profile.out -covermode=atomic "$package_path"
        if [ -f profile.out ]; then
            cat profile.out >> coverage.txt
            rm profile.out
        fi
    done
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®å…¨ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã«ã€ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã®é‡è¦ãªéƒ¨åˆ†ã‚’æŠœç²‹ã—ã¾ã™ã€‚
- `go list ./...`ï¼šã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®å…¨ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹
- `go test "$package_path"`ï¼šå–å¾—ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã™ã‚‹ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚

`go test`ã«ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
  - `-v`ï¼šãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹
  - `-race`ï¼šãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’æ¤œçŸ¥ã™ã‚‹
  - `-coverprofile=profile.out`ï¼šã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å–å¾—ã™ã‚‹
  - `-covermode=atomic`ï¼šã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å–å¾—ã™ã‚‹éš›ã«ã€è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚’çµ±åˆã™ã‚‹


# å·®åˆ†å®Ÿè¡Œã«ã™ã‚‹æ–¹æ³•
## ãƒ–ãƒ©ãƒ³ãƒåã¯ç’°å¢ƒå¤‰æ•°$CIRCLE_BRANCH ã§å–å¾—

CircleCi ã§ã¯ã€ç’°å¢ƒå¤‰æ•°[$CIRCLE_BRANCH](https://circleci.com/docs/ja/variables/)ã§ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
$CIRCLE_BRANCH ã‚’ç”¨ã„ã¦ã€master ãƒ–ãƒ©ãƒ³ãƒã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚

```yaml
if [ "$CIRCLE_BRANCH" = "master" ]; then
    echo "Branch is master"
else
    echo "Branch is neither master nor production"
fi
```

## git diffã§masterãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—


```
git diff ãƒ–ãƒ©ãƒ³ãƒå
```

ã§ã€ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã¨æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã¾ãŸã€

```
git diff HEAD^
```

ã¨ã™ã‚‹ã“ã¨ã§ã€ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## --diff-fileter ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å–å¾—ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµã‚Šè¾¼ã‚€

[gitã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://git-scm.com/docs/git-diff)ã«ã‚ˆã‚‹ã¨ã€

>  --diff-filter=[(A|C|D|M|R|T|U|X|B)â€¦â€‹[*]]
>   Select only files that are Added (A), Copied (C), Deleted (D), Modified (M), Renamed (R), have their type (i.e. regular file, symlink, submodule, â€¦â€‹) changed (T), are Unmerged (U), are Unknown (X), or have had their pairing Broken (B). Any combination of the filter characters (including none) can be used. When \* (All-or-none) is added to the combination, all paths are selected if there is any file that matches other criteria in the comparison; if there is no file that matches other criteria, nothing is selected.

> Also, these upper-case letters can be downcased to exclude. E.g. --diff-filter=ad excludes added and deleted paths.
> Note that not all diffs can feature all types. For instance, copied and renamed entries cannot appear if detection for those types is disabled.

è¦ã¯ã€`--diff-filter=`ã§æŒ‡å®šã—ãŸãƒ•ãƒ©ã‚°ã«è©²å½“ã™ã‚‹å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`--diff-filter=ACMR`

- A: ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸ
- C: ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸ
- M: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸ
- R: ãƒ•ã‚¡ã‚¤ãƒ«ãŒåå‰ã‚’å¤‰æ›´ã—ãŸ

å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ go test ã®å¯¾è±¡ã¨ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€D ã¯å«ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã«å¤‰æ›ã™ã‚‹
`git diff` ã§å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ã€go test ã§æŒ‡å®šã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€`src/controller/hoge/fuga.go` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’`controller/hoge` ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã«å¤‰æ›ã—ã¾ã™ã€‚

```yaml
package_path=$(echo "$file_name" | sed 's#^src/##' | sed 's#/[^/]*$##')
```


## å·®åˆ†å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã¾ã¨ã‚
ä»¥ä¸Šã®ã“ã¨ã‚’è¸ã¾ãˆãŸã€æœ€çµ‚çš„ãªå·®åˆ†å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```yaml
run:
    name: Run tests & make report
    command: |
        echo "" > coverage.txt

        if [ "$CIRCLE_BRANCH" = "master" ]; then
            echo "Branch is master"
            for package_path in $(go list ./... ); do
                go test -v -race -coverprofile=profile.out -covermode=atomic "$package_path"
                if [ -f profile.out ]; then
                    cat profile.out >> coverage.txt
                    rm profile.out
                fi
            done
          else
            echo "Branch is not master"
            visited_packages=()
            for file_name in $(git diff origin/master...HEAD --name-only --diff-filter=ACMR | grep "\.go$"); do
              package_path=$(echo "$file_name" | sed 's#^src/##' | sed 's#/[^/]*$##')
              if [[ " ${visited_packages[@]} " =~ " ${package_path} " ]]; then
                  continue
              fi
              visited_packages+=("$package_path")
              go test -v -race -coverprofile=profile.out -covermode=atomic "$package_path"
              if [ -f profile.out ]; then
                  cat profile.out >> coverage.txt
                  rm profile.out
              fi
            done
          fi
          echo "" > coverage.txt
```

# å‚è€ƒæ–‡çŒ®

CircleCiã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
https://circleci.com/docs/ja/

CircleCiã§ã¯ãªãã€GitHub Actions ã‚’ç”¨ã„ã¦å·®åˆ†å®Ÿè¡Œã‚’ã—ãŸã„å ´åˆã¯ã€ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://zenn.dev/mitsugu/articles/6f4b5f1be6b20a
